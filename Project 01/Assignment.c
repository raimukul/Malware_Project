#include <stdio.h>
#include <windows.h>
#define KRED  "\x1B[31m"
#define KGRN  "\x1B[32m"

int main(int argc, char *argv[])
{

    if (argc != 2)
    {
        printf("Usage: %s <filename> \n \n", argv[0]);
        return 1;
    }

    FILE *file = fopen(argv[1], "rb");
    if (file == NULL)
    {
        printf("Error: Unable to open file '%s'\n", argv[1]);
        return 1;
    }

    // Read the DOS header of an application
    IMAGE_DOS_HEADER dos_header;
    fread(&dos_header, sizeof(dos_header), 1, file);

    // Verify the DOS signature of an application
    if (dos_header.e_magic != IMAGE_DOS_SIGNATURE)
    {
        printf("Error: Invalid DOS signature\n");
        fclose(file);
        return 1;
    }

    // Print out the DOS header fields of an application
    printf("\n" KRED);
    printf("DOS header details below: \n" KGRN);
    printf("e_magic: %04X\n", dos_header.e_magic);
    printf("e_cblp: %04X\n", dos_header.e_cblp);
    printf("e_cp: %04X\n", dos_header.e_cp);
    printf("e_crlc: %04X\n", dos_header.e_crlc);
    printf("e_cparhdr: %04X\n", dos_header.e_cparhdr);
    printf("e_minalloc: %04X\n", dos_header.e_minalloc);
    printf("e_maxalloc: %04X\n", dos_header.e_maxalloc);
    printf("e_ss: %04X\n", dos_header.e_ss);
    printf("e_sp: %04X\n", dos_header.e_sp);
    printf("e_csum: %04X\n", dos_header.e_csum);
    printf("e_ip: %04X\n", dos_header.e_ip);
    printf("e_cs: %04X\n", dos_header.e_cs);
    printf("e_lfarlc: %04X\n", dos_header.e_lfarlc);
    printf("e_ovno: %04X\n", dos_header.e_ovno);
    printf("e_res[4]: %04X\n", dos_header.e_res[4]);
    printf("e_oemid: %04X\n", dos_header.e_oemid);
    printf("e_oeminfo: %04X\n", dos_header.e_oeminfo);
    printf("e_res2[10]: %04X\n", dos_header.e_res2[10]);
    printf("e_lfanew: %04X\n", dos_header.e_lfanew);


    // Seek to the NT header offset of an application
    fseek(file, dos_header.e_lfanew, SEEK_SET);

    // Read the NT header signature of an application
    DWORD nt_signature;
    fread(&nt_signature, sizeof(nt_signature), 1, file);

    // Verify the NT signature of an application
    if (nt_signature != IMAGE_NT_SIGNATURE)
    {
        printf("Error: Invalid NT signature\n");
        fclose(file);
        return 1;
    }

    // Read the COFF header of an application
    IMAGE_FILE_HEADER coff_header;
    fread(&coff_header, sizeof(coff_header), 1, file);

    // Print out the COFF header fields of an application
    printf("\n" KRED);
    printf("COFF header details below:\n" KGRN);
    printf("Machine: %04X\n", coff_header.Machine);
    printf("NumberOfSections: %04X\n", coff_header.NumberOfSections);
    printf("TimeDateStamp: %04X\n", coff_header.TimeDateStamp);
    printf("PointerToSymbolTable: %04X\n", coff_header.PointerToSymbolTable);
    printf("NumberOfSymbols: %04X\n", coff_header.NumberOfSymbols);
    printf("SizeOfOptionalHeader: %04X\n", coff_header.SizeOfOptionalHeader);
    printf("Characteristics: %04X\n", coff_header.Characteristics);

    // Read the optional header
    IMAGE_OPTIONAL_HEADER optional_header;
    fread(&optional_header, sizeof(optional_header), 1, file);

    // Print out the optional header fields
    printf("\n" KRED);
    printf("Optional header details below:\n" KGRN);
    printf("Magic: %04X\n", optional_header.Magic);
    printf("MajorLinkerVersion: %02X\n", optional_header.MajorLinkerVersion);
    printf("MinorLinkerVersion: %02X\n", optional_header.MinorLinkerVersion);
    printf("SizeOfCode: %08X\n", optional_header.SizeOfCode);
    printf("SizeOfInitializedData: %08X\n", optional_header.SizeOfInitializedData);
    printf("SizeOfUninitializedData: %08X\n", optional_header.SizeOfUninitializedData);
    printf("AddressOfEntryPoint: %08X\n", optional_header.AddressOfEntryPoint);
    printf("BaseOfCode: %08X\n", optional_header.BaseOfCode);
}
