#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define ENCRYPTION_KEY 0x40

int main() {
  // Open program1 for reading
  FILE *fp = fopen("program1.exe", "rb");
  if (fp == NULL) {
    printf("Error opening program1.\n");
    return 1;
  }

  // Get size of program1
  fseek(fp, 0, SEEK_END);
  size_t program1_size = ftell(fp);
  fseek(fp, 0, SEEK_SET);

  // Allocate memory to store program1
  unsigned char *program1 = (unsigned char *)malloc(program1_size);
  if (program1 == NULL) {
    printf("Error allocating memory for program1.\n");
    fclose(fp);
    return 1;
  }

  // Read program1 into memory
  fread(program1, 1, program1_size, fp);

  // Encrypt program1 with XOR
  for (size_t i = 0; i < program1_size; i++) {
    program1[i] ^= ENCRYPTION_KEY;
  }

  // Close program1
  fclose(fp);

  // Open program2 for appending
  fp = fopen("program2", "ab");
  if (fp == NULL) {
    printf("Error opening program2.\n");
    free(program1);
    return 1;
  }

  // Write program1 to program2
  size_t bytes_written = fwrite(program1, 1, program1_size, fp);
  if (bytes_written != program1_size) {
    printf("Error writing program1 to program2.\n");
    free(program1);
    fclose(fp);
    return 1;
  }

  // Close program2
  fclose(fp);

  // Free memory used by program1
  free(program1);

  // Print success message
  printf("Program1 encrypted and attached to program2.\n");

  return 0;
}