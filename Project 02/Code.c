#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

void print_import_table(PIMAGE_IMPORT_DESCRIPTOR import_descriptor);
void print_relocation_table(PIMAGE_BASE_RELOCATION base_relocation);
void print_section_table(PIMAGE_SECTION_HEADER section_header);

int main(int argc, char *argv[])
{
    if (argc < 2)
    {
        printf("Usage: %s <path to executable>\n", argv[0]);
        return 1;
    }

    HANDLE file_handle = CreateFile(argv[1], GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);

    if (file_handle == INVALID_HANDLE_VALUE)
    {
        printf("Error opening file %s\n", argv[1]);
        return 1;
    }

    HANDLE file_mapping_handle = CreateFileMapping(file_handle, NULL, PAGE_READONLY, 0, 0, NULL);

    if (file_mapping_handle == NULL)
    {
        printf("Error creating file mapping for %s\n", argv[1]);
        CloseHandle(file_handle);
        return 1;
    }

    LPVOID file_mapping_view = MapViewOfFile(file_mapping_handle, FILE_MAP_READ, 0, 0, 0);

    if (file_mapping_view == NULL)
    {
        printf("Error creating file mapping view for %s\n", argv[1]);
        CloseHandle(file_mapping_handle);
        CloseHandle(file_handle);
        return 1;
    }

    PIMAGE_DOS_HEADER dos_header = (PIMAGE_DOS_HEADER)file_mapping_view;
    PIMAGE_NT_HEADERS nt_header = (PIMAGE_NT_HEADERS)((char *)file_mapping_view + dos_header->e_lfanew);

    printf("IMAGE_DIRECTORY_ENTRY_IMPORT:\n");
    print_import_table((PIMAGE_IMPORT_DESCRIPTOR)((char *)file_mapping_view + nt_header->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress));

    printf("\nIMAGE_DIRECTORY_ENTRY_BASERELOC:\n");
    print_relocation_table((PIMAGE_BASE_RELOCATION)((char *)file_mapping_view + nt_header->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress));

    printf("\nSection Headers:\n");
    print_section_table((PIMAGE_SECTION_HEADER)((char *)nt_header + sizeof(IMAGE_NT_HEADERS)));

    UnmapViewOfFile(file_mapping_view);
    CloseHandle(file_mapping_handle);
    CloseHandle(file_handle);

    return 0;
}

void print_import_table(PIMAGE_IMPORT_DESCRIPTOR import_descriptor)
{
    while (import_descriptor->OriginalFirstThunk != 0)
    {
        printf("  DLL Name: %08X\n", import_descriptor->Name);
        PIMAGE_THUNK_DATA thunk_data = (PIMAGE_THUNK_DATA)((char *)import_descriptor->OriginalFirstThunk);
        while (thunk_data->u1.AddressOfData != 0)
        {
            if (thunk_data->u1.Ordinal & IMAGE_ORDINAL_FLAG)
            {
                printf("    Ordinal: %08X\n", thunk_data->u1.Ordinal & 0xFFFF);
            }
            else
            {
                PIMAGE_IMPORT_BY_NAME import_by_name = (PIMAGE_IMPORT_BY_NAME)((char *)thunk_data->u1.AddressOfData);
                printf("    Function Name: %08X (Hint: %04X)\n", import_by_name->Name, import_by_name->Hint);
            }
            thunk_data++;
        }
        import_descriptor++;
    }
}

void print_relocation_table(PIMAGE_BASE_RELOCATION base_relocation)
{
    while (base_relocation->VirtualAddress != 0)
    {
        printf("  Virtual Address: %08X\n", base_relocation->VirtualAddress);
        DWORD *relocation_entry = (DWORD *)((char *)base_relocation + sizeof(IMAGE_BASE_RELOCATION));
        DWORD num_relocations = (base_relocation->SizeOfBlock - sizeof(IMAGE_BASE_RELOCATION)) / sizeof(DWORD);
        for (int i = 0; i < num_relocations; i++)
        {
            DWORD relocation_type = (*relocation_entry >> 12) & 0xF;
            DWORD relocation_offset = *relocation_entry & 0xFFF;
            printf("    Type: %X Offset: %08X\n", relocation_type, relocation_offset);
            relocation_entry++;
        }
        base_relocation = (PIMAGE_BASE_RELOCATION)((char *)base_relocation + base_relocation->SizeOfBlock);
    }
}

void print_section_table(PIMAGE_SECTION_HEADER section_header)
{
    for (int i = 0; i < section_header->NumberOfRelocations; i++)
    {

        printf("  Name: %.8s\n", section_header->Name);
        printf("    Virtual Address: %08X\n", section_header->VirtualAddress);
        printf("    Size of Raw Data: %08X\n", section_header->SizeOfRawData);
        printf("    Pointer to Raw Data: %08X\n", section_header->PointerToRawData);
        printf("    Characteristics: %08X\n", section_header->Characteristics);
        section_header++;
    }
}
