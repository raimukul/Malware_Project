#include <stdio.h>
#include <windows.h>

int main(int argc, char *argv[])
{
    if (argc != 2)
    {
        printf("Usage: %s <filename>\n", argv[0]);
        return 1;
    }

    HANDLE fileHandle = CreateFile(argv[1], GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
    if (fileHandle == INVALID_HANDLE_VALUE)
    {
        printf("Error opening file %s\n", argv[1]);
        return 1;
    }

    HANDLE mappingHandle = CreateFileMapping(fileHandle, NULL, PAGE_READONLY, 0, 0, NULL);
    if (mappingHandle == NULL)
    {
        printf("Error creating file mapping\n");
        CloseHandle(fileHandle);
        return 1;
    }

    LPVOID mapView = MapViewOfFile(mappingHandle, FILE_MAP_READ, 0, 0, 0);
    if (mapView == NULL)
    {
        printf("Error creating file mapping view\n");
        CloseHandle(mappingHandle);
        CloseHandle(fileHandle);
        return 1;
    }

    PIMAGE_DOS_HEADER dosHeader = (PIMAGE_DOS_HEADER)mapView;
    if (dosHeader->e_magic != IMAGE_DOS_SIGNATURE)
    {
        printf("Invalid DOS signature\n");
        UnmapViewOfFile(mapView);
        CloseHandle(mappingHandle);
        CloseHandle(fileHandle);
        return 1;
    }

    PIMAGE_NT_HEADERS ntHeaders = (PIMAGE_NT_HEADERS)((LPBYTE)dosHeader + dosHeader->e_lfanew);
    if (ntHeaders->Signature != IMAGE_NT_SIGNATURE)
    {
        printf("Invalid NT signature\n");
        UnmapViewOfFile(mapView);
        CloseHandle(mappingHandle);
        CloseHandle(fileHandle);
        return 1;
    }

    PIMAGE_DATA_DIRECTORY importDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];
    printf("Import Directory (virtual address): 0x%08X, size: % 4X\n", importDirectory->VirtualAddress, importDirectory->Size);

    PIMAGE_DATA_DIRECTORY exportDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];
    printf("Export Directory (virtual address): 0x%08X, size: % 4X\n", exportDirectory->VirtualAddress, exportDirectory->Size);

    PIMAGE_DATA_DIRECTORY resourceDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_RESOURCE];
    printf("Resource Directory (virtual address): 0x%08X, size: % 4X\n", resourceDirectory->VirtualAddress, resourceDirectory->Size);

    PIMAGE_DATA_DIRECTORY exceptionDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXCEPTION];
    printf("Exception Directory (virtual address): 0x%08X, size: % 4X\n", exceptionDirectory->VirtualAddress, exceptionDirectory->Size);

    PIMAGE_DATA_DIRECTORY securityDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY];
    printf("Security Directory (virtual address): 0x%08X, size: % 4X\n", securityDirectory->VirtualAddress, securityDirectory->Size);

    PIMAGE_DATA_DIRECTORY baserelocDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];
    printf("Base Relocation Table (virtual address): 0x%08X, size: % 4X\n", baserelocDirectory->VirtualAddress, baserelocDirectory->Size);

    PIMAGE_DATA_DIRECTORY debugDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_DEBUG];
    printf("Debug Directory (virtual address): 0x%08X, size: % 4X\n", debugDirectory->VirtualAddress, debugDirectory->Size);

    PIMAGE_DATA_DIRECTORY architectureDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_ARCHITECTURE];
    printf("Architecture Specific Data (virtual address): 0x%08X, size: % 4X\n", architectureDirectory->VirtualAddress, architectureDirectory->Size);

    PIMAGE_DATA_DIRECTORY globalptrDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_GLOBALPTR];
    printf("RVA of GP (virtual address): 0x%08X, size: % 4X\n", globalptrDirectory->VirtualAddress, globalptrDirectory->Size);

    PIMAGE_DATA_DIRECTORY tlsDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS];
    printf("TLS Directory (virtual address): 0x%08X, size: % 4X\n", tlsDirectory->VirtualAddress, tlsDirectory->Size);

    PIMAGE_DATA_DIRECTORY loadconFigDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG];
    printf("Load Configuration Directory (virtual address): 0x%08X, size: % 4X\n", loadconFigDirectory->VirtualAddress, loadconFigDirectory->Size);

    PIMAGE_DATA_DIRECTORY boundImportDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT];
    printf("Bound Import Directory in headers (virtual address): 0x%08X, size: % 4X\n", boundImportDirectory->VirtualAddress, boundImportDirectory->Size);

    PIMAGE_DATA_DIRECTORY iatDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IAT];
    printf("Import Address Table (virtual address): 0x%08X, size: % 4X\n", iatDirectory->VirtualAddress, iatDirectory->Size);

    PIMAGE_DATA_DIRECTORY delayImportDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT];
    printf("Delay Load Import Descriptors (virtual address): 0x%08X, size: % 4X\n", delayImportDirectory->VirtualAddress, delayImportDirectory->Size);

    PIMAGE_DATA_DIRECTORY descriptorDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR];
    printf("COM Runtime descriptor (virtual address): 0x%08X, size: % 4X\n", descriptorDirectory->VirtualAddress, descriptorDirectory->Size);

      PIMAGE_DATA_DIRECTORY relocDirectory = &ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];
    printf("IMAGE_DIRECTORY_ENTRY_BASERELOC (virtual address): 0x%08X, size: % 4X\n", relocDirectory->VirtualAddress, relocDirectory->Size);

    UnmapViewOfFile(mapView);
    CloseHandle(mappingHandle);
    CloseHandle(fileHandle);

    return 0;
}
